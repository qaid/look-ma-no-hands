name: Security Checks

on:
  push:
    branches: [ main, security-* ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

permissions:
  contents: read
  security-events: write

jobs:
  verify-dependencies:
    name: Verify Package.resolved Integrity
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Resolve dependencies
        run: swift package resolve

      - name: Check for unexpected changes
        run: |
          if ! git diff --exit-code Package.resolved; then
            echo "❌ Package.resolved changed after resolve!"
            echo "This may indicate dependency tampering."
            exit 1
          fi
          echo "✅ Package.resolved integrity verified"

      - name: Verify WhisperKit revision
        run: |
          EXPECTED_REV="3900754c847a86f4b03df7e0a772933613d79c67"
          ACTUAL_REV=$(grep -A 5 '"identity" : "whisperkit"' Package.resolved | grep '"revision"' | cut -d'"' -f4)

          if [ "$ACTUAL_REV" != "$EXPECTED_REV" ]; then
            echo "❌ WhisperKit revision mismatch!"
            echo "Expected: $EXPECTED_REV"
            echo "Actual: $ACTUAL_REV"
            exit 1
          fi
          echo "✅ WhisperKit revision verified: $ACTUAL_REV"

  build-verification:
    name: Verify Clean Build
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build release
        run: swift build -c release

      - name: Run basic functionality test
        run: |
          # Verify binary was created
          test -f .build/release/LookMaNoHands
          echo "✅ Release binary built successfully"

  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for Gitleaks

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependency-scan:
    name: Scan Dependencies for Vulnerabilities
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OSV-Scanner
        run: |
          curl -L https://github.com/google/osv-scanner/releases/download/v1.8.5/osv-scanner_linux_amd64 -o osv-scanner
          chmod +x osv-scanner

      - name: Run OSV-Scanner
        run: |
          ./osv-scanner --lockfile=Package.resolved --format=json --output=osv-results.json || true

      - name: Upload OSV Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: osv-scan-results
          path: osv-results.json

      - name: Display Vulnerabilities
        if: always()
        run: |
          if [ -f osv-results.json ]; then
            echo "=== Dependency Vulnerabilities Found ==="
            cat osv-results.json
          fi

  entitlements-check:
    name: Verify App Entitlements
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build app bundle
        run: ./deploy.sh

      - name: Verify entitlements
        run: |
          chmod +x scripts/verify-entitlements.sh
          ./scripts/verify-entitlements.sh ~/Applications/"Look Ma No Hands.app"
