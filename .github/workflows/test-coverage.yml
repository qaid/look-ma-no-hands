name: Test Coverage

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

permissions:
  contents: read

jobs:
  test:
    name: Run Tests
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tests with coverage
        run: swift test --enable-code-coverage

      - name: Generate coverage report
        run: |
          TEST_BUNDLE=$(find .build -type d -name '*.xctest' | head -1)
          if [ -n "$TEST_BUNDLE" ]; then
            TEST_NAME=$(basename "$TEST_BUNDLE" .xctest)
            BINARY="$TEST_BUNDLE/Contents/MacOS/$TEST_NAME"
          else
            BINARY=""
          fi
          PROFDATA=$(find .build -type f -name '*.profdata' | head -1)
          if [ -n "$PROFDATA" ] && [ -f "$BINARY" ]; then
            xcrun llvm-cov export \
              "$BINARY" \
              --instr-profile="$PROFDATA" \
              --format=lcov \
              --ignore-filename-regex='.build|Tests' \
              > coverage.lcov
            echo "Coverage report generated."
          else
            echo "Could not locate profdata or test binary for coverage export."
            exit 1
          fi

      - name: Upload coverage to Codecov
        if: ${{ hashFiles('coverage.lcov') != '' }}
        uses: codecov/codecov-action@v4
        with:
          files: coverage.lcov
          fail_ci_if_error: false
